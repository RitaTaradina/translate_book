# 4.12 Сеть между роботом и компьютером

Довольно типичная установка при использовании ROS-это установка ноутбука или одноплатного компьютера на робота, одновременно контролируя его действия на настольном компьютере. ROS позволяет относительно легко для нескольких машин просматривать один и тот же набор тем, служб и параметров. Это особенно полезно, когда бортовой компьютер вашего робота не очень мощный, так как он позволяет запускать более сложные процессы, такие как RViz на вашем рабочем столе. \(Такие программы, как RViz, также могут очень быстро разряжать батарею ноутбука.\)

#### _4.12.1 Синхронизация Времени_

Временная синхронизация между машинами часто имеет решающее значение в сети ROS, поскольку преобразования кадров и многие типы сообщений имеют временные метки. Простой способ сохранить ваши компьютеры синхронизированными - это установить пакет Ubuntu chrony как на ваш рабочий стол, так и на вашего робота. Этот пакет будет держать ваши компьютерные часы синхронизированными с интернет-серверами и, следовательно, друг с другом. 

Чтобы установить chrony, выполните следующую команду:

```text
$ sudo apt-get install chrony
```

После установки служба chrony автоматически запустится и начнет синхронизировать часы вашего компьютера с несколькими интернет-серверами.

#### _4.12.2 Сеть ROS с использованием Zeroconf_

Более поздние версии Ubuntu включают поддержку [Zeroconf](http://en.wikipedia.org/wiki/Zero_configuration_networking), метода, который позволяет машинам в одной подсети ссылаться друг на друга, используя локальные имена хостов вместо IP-адресов. Таким образом, вы можете использовать этот метод, если ваш настольный компьютер и робот подключены к одному и тому же маршрутизатору в домашней или офисной сети—общий сценарий как для хобби, так и для исследовательских роботов. 

Используйте команду hostname для определения короткого имени Вашего компьютера. Результатом будет имя, которое вы выбрали во время первоначальной установки Ubuntu на этом компьютере. Например, если вы назвали свой настольный компьютер "my\_desktop", выходные данные будут выглядеть следующим образом:

```text
$ hostname my_desktop
```

Чтобы получить имя хоста Zeroconf, просто добавьте ".local " после имени хоста, так что в этом случае имя хоста Zeroconf будет:

> my\_desktop.local

Затем выполните команду hostname на компьютере вашего робота, чтобы получить его имя хоста и добавить ".local", чтобы получить свое имя Zeroconf. Давайте предположим, что имя вашего робота Zeroconf-это:

> my\_robot.local

Теперь нам нужно проверить, могут ли машины видеть друг друга в сети.

#### _4.12.3 Тестирование Подключения_

Используйте команду ping, чтобы убедиться, что у вас есть базовое подключение между двумя компьютерами. С вашего компьютера выполните команду:

```text
$ ping my_robot.local
```

что должно привести к следующему результату:

> ROS by Example
>
> PING my\_robot.local \(192.168.0.197\) 56\(84\) bytes of data.  
>  64 bytes from my\_robot.local \(192.168.0.197\): icmp\_req=1 ttl=64 time=1.65 ms  
>  64 bytes from my\_robot.local \(192.168.0.197\): icmp\_req=2 ttl=64 time=0.752 ms  
>  64 bytes from my\_robot.local \(192.168.0.197\): icmp\_req=3 ttl=64 time=1.69 ms

Введите Ctrl-C, чтобы остановить тест. Переменная icmp\_req подсчитывает пинги, в то время как переменная time указывает время обратного хода в миллисекундах. После остановки теста вы получите резюме, которое выглядит следующим образом:

> ROS by Example
>
> --- my\_robot.local ping statistics ---  
>  3 packets transmitted, 3 received, 0% packet loss, time 2001ms rtt min/avg/max/mdev = 0.752/1.367/1.696/0.436 ms

В общем случае вы должны видеть потерю пакетов 0% и среднее время задержки около 5 мс.

 Теперь сделайте тест в другом направлении. Вызовите терминал на вашем роботе \(или используйте ssh, если вы знаете, что он уже работает\) и пропингуйте свой рабочий стол:

```text
$ ping my_desktop.local
```

Еще раз вы должны увидеть 0% потери пакетов и короткое время поездки туда и обратно. 

**Примечание**: Если тест ping не проходит с ошибкой "неизвестный хост", попробуйте перезапустить avahi- процесс демона на машине, которая не отвечает на запросы:

```text
$ sudo service avahi-daemon restart
```

#### _4.12.4 Установка переменных ROS\_MASTER\_URI и ROS\_HOSTNAME_

В любой дорожной сети одна машина назначается мастером ROS, и только она управляет процессом roscoreprocess. Затем другие машины должны установить переменную окружения theROS\_MASTER\_URI так, чтобы она указывала на главный хост. Каждый компьютер также должен установить свое имя хоста ROS соответствующим образом, как мы покажем.

 В общем, не имеет значения, какую машину вы выберете в качестве мастера. Однако для полностью автономного робота вы, вероятно, захотите сделать компьютер робота хозяином, чтобы он никоим образом не зависел от рабочего стола. 

Если мы хотим, чтобы робот был мастером ROS, мы устанавливаем его ROS\_HOSTNAME на его имя Zeroconf и запускаем процесс roscore:

_**На роботе:**_

```text
$ export ROS_HOSTNAME=my_robot.local
$ roscore
```

Затем перейдите на рабочий стол, установите ROS\_HOSTNAME на его имя Zeroconf, а затем установите переменная ROS\_MASTER\_URI указывает на URI Zeroconf вашего робота.

_**На рабочем столе:**_

```text
$ export ROS_HOSTNAME=my_desktop.local
$ export ROS_MASTER_URI=http://my_robot.local:11311
```

Для дополнительной проверки синхронизации времени мы можем запустить команду ntpdate для синхронизации рабочего стола с роботом.

_**На рабочем столе:**_

```text
$ sudo ntpdate -b my_robot.local
```

Если все пойдет хорошо, вы должны быть в состоянии увидеть темы /rosin и /rosin\_agg на ваш рабочий стол выглядит следующим образом:

```text
$ rostopic list
```

> ```text
> /rosout
> /rosout_agg
> ```

_**4.12.5 Открытие Новых Терминалов**_

В любом новом окне терминала, которое вы открываете на своем рабочем столе или роботе, вам нужно установить переменную ROS\_HOSTNAME на имя Zeroconf этой машины. А для новых настольных терминалов вы также должны установить ROS\_MASTER\_URI, чтобы он указывал на робота. \(Или в более общем смысле, на любом компьютере, не являющемся главным, новые терминалы должны установить ROS\_MASTER\_URI для указания на главный компьютер.\)

Если вы будете использовать один и тот же робот и рабочий стол в течение некоторого времени, вы можете сэкономить некоторое время, добавив соответствующие строки экспорта в конец ~/.файл bashrc на каждом компьютере. Если робот всегда будет хозяином, добавьте следующую строку в конец его ~/.файл bashrc:

> export ROS\_HOSTNAME=my\_robot.local

А на рабочем столе добавьте следующие две строки в конец его ~/.файл bashrc:

> export ROS\_HOSTNAME=my\_desktop.local
>
> export ROS\_MASTER\_URI=http://my\_robot.local:11311

\(Конечно, замените имена Zeroconf теми, которые соответствуют вашей настройке.\) 

Вы также можете настроить свой рабочий стол в качестве мастера ROS вместо робота. В этом случае просто измените роли и имя хоста Zeroconf в приведенных выше примерах.

_**4.12.6 Running Nodes on both Machines**_

Теперь, когда у вас есть сеть ROS, настроенная между вашим роботом и настольным компьютером, вы можете запускать узлы ROS на любом компьютере, и оба будут иметь доступ ко всем темам и службам. 

В то время как многие узлы и файлы запуска могут быть запущены на любом компьютере, файлы запуска робота всегда должны быть запущены на роботе, так как эти узлы предоставляют драйверы для оборудования робота. Это включает в себя драйверы для базы роботов и любые камеры, лазерные сканеры или другие датчики, которые вы хотите использовать. С другой стороны, рабочий стол-это хорошее место для запуска RViz, так как он очень интенсивен для процессора, и, кроме того, вы в любом случае захотите следить за своим роботом с рабочего стола.

 Поскольку компьютер робота не всегда может иметь клавиатуру и монитор, вы можете использовать ssh для входа в свой робот и запуска узлов драйверов с рабочего стола. Вот пример того, как вы можете это сделать. 

С вашего настольного компьютера используйте ssh для входа в систему вашего робота. 

_**На рабочем столе:**_

```text
$ ssh my_robot.local
```

После того, как вы вошли в систему робота, запустите roscore и файл запуска запуска вашего робота.

_**На роботе \(через ssh\)**_:

```text
$ export ROS_HOSTNAME=my_robot.local 
$ roscore &
$ roslaunch my_robot startup.launch
```

\(Вы можете опустить первую строку экспорта выше, если вы уже включили ее в ~/робота.файл bashrc.\) 

Обратите внимание, как мы отправляем процесс roscore в фоновом режиме, используя символ & после команды. Это возвращает командную строку, так что мы можем запустить файл запуска нашего робота без необходимости открытия другого сеанса ssh. Если это возможно, запустите все аппаратные драйверы вашего робота в одном запуске.запустите файл \(его можно назвать как угодно\). Таким образом, вам не придется открывать дополнительные терминалы для запуска других драйверов. 

Вернитесь на рабочий стол, откройте другое окно терминала, установите ROS\_MASTER\_URI, чтобы он указывал на вашего робота, а затем запустите RViz:

_**На рабочем столе:**_

```text
$ export ROS_HOSTNAME=my_desktop.local
$ export ROS_MASTER_URI=http://my_robot.local:11311
$ rosrun rviz rviz -d `rospack find rbx1_nav`/nav.rviz
```

\(Вы можете опустить две строки экспорта, если вы уже включили их в ~ / рабочего стола.файл bashrc.\) 

Здесь мы запускаем RViz с одним из конфигурационных файлов, включенных в навигационный пакет ros-by - example, но вы также можете просто запустить RViz без какого-либо конфигурационного файла.

#### _**4.12.7 Сеть ROS через Интернет**_

Хотя это и не входит в рамки данной книги, настройка узлов ROS для связи через Интернет аналогична приведенным выше инструкциям с использованием Zeroconf. Главное отличие заключается в том, что теперь вам нужно использовать полные имена хостов или IP-адреса вместо локальных имен Zeroconf. Кроме того, вполне вероятно, что одна или несколько машин будут находиться за брандмауэром, так что придется настроить некоторую форму VPN \(например, [OpenVPN](https://help.ubuntu.com/14.04/serverguide/openvpn.html)\). Наконец, поскольку большинство машин в сети ROS будет подключено к локальному маршрутизатору \(напр. точка доступа Wi-Fi\), вам нужно будет настроить переадресацию портов на этом маршрутизаторе или использовать динамический DNS. Хотя все это возможно, это определенно не тривиальная установка.

